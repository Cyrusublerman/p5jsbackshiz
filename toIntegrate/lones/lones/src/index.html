<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Serpentine Halftone</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg: #1a1a1a;
      --surface: #252525;
      --border: #3a3a3a;
      --text: #e0e0e0;
      --text-dim: #888;
      --accent: #c8d2d0;
      --danger: #c47070;
    }

    body {
      font-family: 'JetBrains Mono', monospace;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
      gap: 1rem;
    }

    h1 {
      font-size: 0.8rem;
      font-weight: 500;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--text-dim);
    }

    .container {
      display: flex;
      gap: 1rem;
      align-items: flex-start;
      flex-wrap: wrap;
      justify-content: center;
    }

    #canvas-container {
      background: var(--surface);
      border: 1px solid var(--border);
    }

    .panels-wrapper {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      max-height: 90vh;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--border) transparent;
    }

    .panel {
      background: var(--surface);
      border: 1px solid var(--border);
      padding: 0.875rem;
      width: 260px;
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
    }

    .panel.hidden { display: none; }

    .panel-title {
      font-size: 0.6rem;
      font-weight: 500;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-dim);
      padding-bottom: 0.3rem;
      border-bottom: 1px solid var(--border);
    }

    .dropzone {
      border: 2px dashed var(--border);
      padding: 1rem 0.5rem;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
    }

    .dropzone:hover, .dropzone.dragover {
      border-color: var(--accent);
      background: rgba(200, 210, 208, 0.05);
    }

    .dropzone-text {
      font-size: 0.65rem;
      color: var(--text-dim);
      line-height: 1.4;
    }

    .dropzone-text span { color: var(--accent); text-decoration: underline; }

    .preview-container { display: none; flex-direction: column; gap: 0.4rem; }
    .preview-container.active { display: flex; }
    .preview-img { width: 100%; height: 60px; object-fit: cover; border: 1px solid var(--border); }
    .file-info { font-size: 0.55rem; color: var(--text-dim); display: flex; justify-content: space-between; }

    .control-group { display: flex; flex-direction: column; gap: 0.2rem; }
    .control-label { display: flex; justify-content: space-between; align-items: baseline; font-size: 0.6rem; }
    .control-label span:first-child { color: var(--text-dim); }
    .control-label .value { color: var(--accent); font-weight: 500; }

    input[type="range"] {
      -webkit-appearance: none; appearance: none;
      width: 100%; height: 3px;
      background: var(--border); border-radius: 2px;
      outline: none; cursor: pointer;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none; appearance: none;
      width: 10px; height: 10px;
      background: var(--accent); border-radius: 50%; cursor: pointer;
    }
    input[type="range"]::-moz-range-thumb {
      width: 10px; height: 10px;
      background: var(--accent); border: none; border-radius: 50%; cursor: pointer;
    }

    .btn {
      font-family: inherit; font-size: 0.6rem;
      letter-spacing: 0.05em; text-transform: uppercase;
      padding: 0.4rem 0.6rem;
      border: 1px solid var(--border);
      background: transparent; color: var(--text);
      cursor: pointer; transition: all 0.2s;
    }
    .btn:hover { background: var(--accent); color: var(--bg); border-color: var(--accent); }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .btn:disabled:hover { background: transparent; color: var(--text); border-color: var(--border); }

    .btn.recording {
      border-color: var(--danger); color: var(--danger);
      animation: pulse-border 1s ease infinite;
    }
    @keyframes pulse-border {
      0%, 100% { border-color: var(--danger); }
      50% { border-color: transparent; }
    }

    .btn-row { display: flex; gap: 0.4rem; }
    .btn-row .btn { flex: 1; }
    .status { font-size: 0.55rem; color: var(--text-dim); text-align: center; padding: 0.3rem; background: rgba(0,0,0,0.2); }
    .divider { height: 1px; background: var(--border); margin: 0.15rem 0; }
    #file-input { display: none; }

    .checkbox-row { display: flex; align-items: center; gap: 0.4rem; font-size: 0.6rem; color: var(--text-dim); cursor: pointer; }
    .checkbox-row input { accent-color: var(--accent); cursor: pointer; }

    select {
      font-family: inherit; font-size: 0.6rem; padding: 0.3rem;
      background: var(--bg); border: 1px solid var(--border); color: var(--text); cursor: pointer;
    }

    input[type="color"] {
      -webkit-appearance: none; appearance: none;
      width: 28px; height: 20px;
      border: 1px solid var(--border); background: transparent; cursor: pointer; padding: 0;
    }
    input[type="color"]::-webkit-color-swatch-wrapper { padding: 1px; }
    input[type="color"]::-webkit-color-swatch { border: none; }

    .color-row { display: flex; align-items: center; justify-content: space-between; font-size: 0.6rem; color: var(--text-dim); }
    .color-row-right { display: flex; align-items: center; gap: 0.4rem; }
    .color-hex { font-size: 0.55rem; color: var(--accent); }

    .progress-bar-track { width: 100%; height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; }
    .progress-bar-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.1s linear; }

    .mode-toggle { display: flex; border: 1px solid var(--border); }
    .mode-toggle .mode-btn {
      flex: 1; font-family: inherit; font-size: 0.5rem;
      letter-spacing: 0.04em; text-transform: uppercase;
      padding: 0.35rem 0.3rem; border: none;
      background: transparent; color: var(--text-dim);
      cursor: pointer; transition: all 0.2s;
    }
    .mode-toggle .mode-btn.active { background: var(--accent); color: var(--bg); }

    .hint { font-size: 0.5rem; color: var(--text-dim); }
  </style>
</head>
<body>
  <h1>Serpentine Halftone</h1>

  <div class="container">
    <div id="canvas-container"></div>

    <div class="panels-wrapper">

      <!-- IMAGE SOURCE -->
      <div class="panel">
        <div class="panel-title">Image Source</div>
        <div class="dropzone" id="dropzone">
          <div class="dropzone-text">Drop image here or <span>browse</span></div>
        </div>
        <input type="file" id="file-input" accept="image/*">
        <div class="preview-container" id="preview-container">
          <img class="preview-img" id="preview-img" alt="Preview">
          <div class="file-info">
            <span id="file-name">—</span>
            <span id="file-dims">—</span>
          </div>
        </div>
        <div class="control-group">
          <label class="control-label"><span>Fit Mode</span></label>
          <select id="ctrl-fit-mode">
            <option value="contain">Contain (no crop)</option>
            <option value="cover">Cover (crop to fill)</option>
          </select>
        </div>
        <div class="control-group">
          <label class="control-label"><span>Canvas Scale</span></label>
          <select id="ctrl-scale">
            <option value="0.125">1/8×</option>
            <option value="0.25">1/4×</option>
            <option value="0.5" selected>1/2×</option>
            <option value="1">1×</option>
            <option value="2">2×</option>
          </select>
        </div>
        <div class="btn-row">
          <button class="btn" id="btn-pause">Pause</button>
          <button class="btn" id="btn-reset">Reset</button>
        </div>
        <div class="status" id="status">Awaiting image...</div>
      </div>

      <!-- ENGINE MODE -->
      <div class="panel">
        <div class="panel-title">Engine Mode</div>
        <div class="mode-toggle" id="mode-toggle">
          <button class="mode-btn active" data-mode="flow">Flow</button>
          <button class="mode-btn" data-mode="static">Static</button>
          <button class="mode-btn" data-mode="serpentine">Serpentine</button>
        </div>
        <div class="control-group" id="grp-orientation">
          <label class="control-label"><span>Orientation</span></label>
          <select id="ctrl-orientation">
            <option value="horizontal">Horizontal</option>
            <option value="vertical">Vertical</option>
          </select>
        </div>
        <label class="checkbox-row">
          <input type="checkbox" id="ctrl-invert">
          Invert Luminance
        </label>
      </div>

      <!-- FLOW LINES -->
      <div class="panel" id="panel-flow">
        <div class="panel-title">Flow Lines</div>
        <div class="control-group">
          <label class="control-label"><span>Line Spacing</span><span class="value" id="val-flow-spacing">6</span></label>
          <input type="range" id="ctrl-flow-spacing" min="2" max="40" value="6" step="1">
        </div>
        <div class="control-group">
          <label class="control-label"><span>Osc Amplitude</span><span class="value" id="val-flow-amplitude">2.5</span></label>
          <input type="range" id="ctrl-flow-amplitude" min="0.5" max="20" value="2.5" step="0.5">
        </div>
        <div class="control-group">
          <label class="control-label"><span>Wave Frequency</span><span class="value" id="val-flow-freq">1.00</span></label>
          <input type="range" id="ctrl-flow-freq" min="0.1" max="5" value="1" step="0.1">
        </div>
        <div class="control-group">
          <label class="control-label"><span>Sample Step</span><span class="value" id="val-flow-step">1.0</span></label>
          <input type="range" id="ctrl-flow-step" min="0.5" max="5" value="1" step="0.25">
        </div>
        <div class="control-group">
          <label class="control-label"><span>Base Speed</span><span class="value" id="val-flow-speed">0.50</span></label>
          <input type="range" id="ctrl-flow-speed" min="0.05" max="3" value="0.5" step="0.05">
        </div>
        <div class="divider"></div>
        <div class="control-group">
          <label class="control-label"><span>Phase Increment</span><span class="value" id="val-flow-phase-inc">0.00</span></label>
          <input type="range" id="ctrl-flow-phase-inc" min="0" max="3.14" value="0" step="0.01">
        </div>
        <div class="hint">Phase offset between consecutive wave fronts</div>
        <div class="divider"></div>
        <div class="control-group">
          <label class="control-label"><span>Stop Spawn Frame</span><span class="value" id="val-flow-stop-spawn">0</span></label>
          <input type="range" id="ctrl-flow-stop-spawn" min="0" max="5000" value="0" step="10">
        </div>
        <div class="hint">0 = never stop. Set to create a clean loop endpoint.</div>
      </div>

      <!-- STATIC LINES -->
      <div class="panel hidden" id="panel-static">
        <div class="panel-title">Static Lines</div>
        <div class="control-group">
          <label class="control-label"><span>Line Spacing</span><span class="value" id="val-static-spacing">6</span></label>
          <input type="range" id="ctrl-static-spacing" min="2" max="40" value="6" step="1">
        </div>
        <div class="control-group">
          <label class="control-label"><span>Max Amplitude</span><span class="value" id="val-static-amplitude">3.0</span></label>
          <input type="range" id="ctrl-static-amplitude" min="0.5" max="30" value="3" step="0.5">
        </div>
        <div class="control-group">
          <label class="control-label"><span>Frequency</span><span class="value" id="val-static-freq">60</span></label>
          <input type="range" id="ctrl-static-freq" min="5" max="300" value="60" step="1">
        </div>
        <div class="control-group">
          <label class="control-label"><span>Sample Density</span><span class="value" id="val-static-step">1.0</span></label>
          <input type="range" id="ctrl-static-step" min="0.5" max="5" value="1" step="0.25">
        </div>
        <div class="divider"></div>
        <div class="control-group">
          <label class="control-label"><span>Phase Offset</span><span class="value" id="val-static-phase">0.00</span></label>
          <input type="range" id="ctrl-static-phase" min="0" max="6.28" value="0" step="0.01">
        </div>
        <div class="control-group">
          <label class="control-label"><span>Phase Increment</span><span class="value" id="val-static-phase-inc">0.00</span></label>
          <input type="range" id="ctrl-static-phase-inc" min="0" max="3.14" value="0" step="0.01">
        </div>
        <div class="divider"></div>
        <div class="control-group">
          <label class="control-label"><span>Amp Curve</span></label>
          <select id="ctrl-static-curve">
            <option value="linear">Linear</option>
            <option value="exponential">Exponential</option>
            <option value="logarithmic">Logarithmic</option>
            <option value="sigmoid">Sigmoid</option>
          </select>
        </div>
        <div class="control-group">
          <label class="control-label"><span>Curve Strength</span><span class="value" id="val-static-curve-str">2.0</span></label>
          <input type="range" id="ctrl-static-curve-str" min="0.5" max="5" value="2" step="0.1">
        </div>
      </div>

      <!-- SERPENTINE OSCILLATION -->
      <div class="panel hidden" id="panel-serp-osc">
        <div class="panel-title">Oscillation</div>
        <div class="control-group">
          <label class="control-label"><span>Spawn Rate (pts/f)</span><span class="value" id="val-serp-spawn">20</span></label>
          <input type="range" id="ctrl-serp-spawn" min="1" max="100" value="20" step="1">
        </div>
        <div class="control-group">
          <label class="control-label"><span>Wave Frequency</span><span class="value" id="val-serp-freq">1.0</span></label>
          <input type="range" id="ctrl-serp-freq" min="0.1" max="5" value="1" step="0.1">
        </div>
        <div class="divider"></div>
        <div class="control-group">
          <label class="control-label"><span>Osc Top (%)</span><span class="value" id="val-osc-top">0</span></label>
          <input type="range" id="ctrl-osc-top" min="0" max="49" value="0" step="1">
        </div>
        <div class="control-group">
          <label class="control-label"><span>Osc Bottom (%)</span><span class="value" id="val-osc-bottom">100</span></label>
          <input type="range" id="ctrl-osc-bottom" min="51" max="100" value="100" step="1">
        </div>
        <div class="divider"></div>
        <div class="control-group">
          <label class="control-label"><span>Base Speed</span><span class="value" id="val-serp-speed">0.30</span></label>
          <input type="range" id="ctrl-serp-speed" min="0.05" max="2" value="0.3" step="0.05">
        </div>
      </div>

      <!-- DRAG RESPONSE (flow + serpentine) -->
      <div class="panel" id="panel-drag">
        <div class="panel-title">Drag Response</div>
        <div class="control-group">
          <label class="control-label"><span>Drag (Bright)</span><span class="value" id="val-drag-light">0.00</span></label>
          <input type="range" id="ctrl-drag-light" min="0" max="0.8" value="0" step="0.01">
        </div>
        <div class="control-group">
          <label class="control-label"><span>Drag (Dark)</span><span class="value" id="val-drag-dark">0.50</span></label>
          <input type="range" id="ctrl-drag-dark" min="0" max="0.95" value="0.5" step="0.01">
        </div>
        <div class="divider"></div>
        <div class="control-group">
          <label class="control-label"><span>Response Curve</span></label>
          <select id="ctrl-curve-type">
            <option value="linear">Linear</option>
            <option value="exponential">Exponential</option>
            <option value="logarithmic">Logarithmic</option>
            <option value="sigmoid">Sigmoid</option>
          </select>
        </div>
        <div class="control-group">
          <label class="control-label"><span>Curve Strength</span><span class="value" id="val-curve-strength">2.0</span></label>
          <input type="range" id="ctrl-curve-strength" min="0.5" max="5" value="2" step="0.1">
        </div>
      </div>

      <!-- LINE TENSION (flow + serpentine) -->
      <div class="panel" id="panel-tension">
        <div class="panel-title">Line Tension</div>
        <div class="control-group">
          <label class="control-label"><span>Base Tension</span><span class="value" id="val-tension">0.05</span></label>
          <input type="range" id="ctrl-tension" min="0" max="0.3" value="0.05" step="0.01">
        </div>
        <div class="control-group">
          <label class="control-label"><span>Bright Tension Boost</span><span class="value" id="val-tension-boost">0.15</span></label>
          <input type="range" id="ctrl-tension-boost" min="0" max="0.5" value="0.15" step="0.01">
        </div>
        <div class="control-group">
          <label class="control-label"><span>Bright Threshold</span><span class="value" id="val-bright-thresh">0.50</span></label>
          <input type="range" id="ctrl-bright-thresh" min="0.1" max="0.9" value="0.5" step="0.05">
        </div>
        <div class="control-group">
          <label class="control-label"><span>Max Segment Length</span><span class="value" id="val-max-seg">10</span></label>
          <input type="range" id="ctrl-max-seg" min="2" max="50" value="10" step="1">
        </div>
      </div>

      <!-- RENDERING -->
      <div class="panel">
        <div class="panel-title">Rendering</div>
        <div class="color-row">
          <span>Background</span>
          <div class="color-row-right">
            <span class="color-hex" id="val-bg-color">#ffffff</span>
            <input type="color" id="ctrl-bg-color" value="#ffffff">
          </div>
        </div>
        <div class="color-row">
          <span>Stroke</span>
          <div class="color-row-right">
            <span class="color-hex" id="val-stroke-color">#000000</span>
            <input type="color" id="ctrl-stroke-color" value="#000000">
          </div>
        </div>
        <div class="control-group">
          <label class="control-label"><span>Line Weight</span><span class="value" id="val-weight">1.0</span></label>
          <input type="range" id="ctrl-weight" min="0.25" max="4" value="1" step="0.25">
        </div>
        <div class="control-group">
          <label class="control-label"><span>Line Opacity</span><span class="value" id="val-opacity">255</span></label>
          <input type="range" id="ctrl-opacity" min="10" max="255" value="255" step="5">
        </div>
      </div>

      <!-- ANIMATION -->
      <div class="panel">
        <div class="panel-title">Animation</div>
        <div class="control-group" id="grp-draw-progress">
          <label class="control-label"><span>Draw Progress</span><span class="value" id="val-draw-progress">100%</span></label>
          <input type="range" id="ctrl-draw-progress" min="0" max="100" value="100" step="1">
        </div>
        <div class="divider"></div>
        <div class="control-group">
          <label class="control-label"><span>Anim Frames</span><span class="value" id="val-anim-frames">120</span></label>
          <input type="range"